<!doctype html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Online Club Management (ระบบจัดการชมรมออนไลน์)</title><!-- Tailwind CSS CDN for modern styling --><script src="https://www.google.com/search?q=https://cdn.tailwindcss.com"></script><!-- SweetAlert2 CDN for attractive alerts --><script src="https://www.google.com/search?q=https://cdn.jsdelivr.net/npm/sweetalert2%4011"></script><style>@import url('https://www.google.com/search?q=https://fonts.googleapis.com/css2%3Ffamily%3DSarabun:wght%40400%3B700%26display%3Dswap');    body {
        font-family: 'Sarabun', sans-serif;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        min-height: 100vh;
        color: #333;
        padding: 20px;
    }

    .glass-container {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        max-width: 900px;
        margin: 0 auto;
    }
    
    .btn-primary {
        @apply bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg;
    }
    
    .btn-secondary {
        @apply bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg;
    }

    .input-field {
        @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 transition duration-200;
    }
    
    .data-table th, .data-table td {
        @apply p-3 text-sm text-gray-800 border-b border-gray-200;
    }
    .data-table th {
        @apply bg-gray-100 font-semibold text-left;
    }
    
    /* Custom SweetAlert2 styling for a better look */
    .swal2-popup {
        border-radius: 15px !important;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2) !important;
    }
</style></head><body class="flex flex-col items-center justify-center"><div class="glass-container w-full"><h1 class="text-4xl font-bold text-white text-center mb-6 drop-shadow-md">ระบบจัดการข้อมูลสมาชิกชมรมออนไลน์</h1><!-- ส่วนฟอร์มบันทึกข้อมูล --><section class="bg-white/90 p-6 rounded-xl mb-8 shadow-inner"><h2 class="text-2xl font-semibold mb-4 text-gray-700">บันทึกข้อมูลสมาชิก (Local & Sheet)</h2><form id="clubForm" class="space-y-4"><div><label for="memberId" class="block text-sm font-medium text-gray-700">รหัสสมาชิก (ID)</label><input type="text" id="memberId" name="memberId" class="input-field" placeholder="เช่น 001" required></div><div><label for="memberName" class="block text-sm font-medium text-gray-700">ชื่อสมาชิก</label><input type="text" id="memberName" name="memberName" class="input-field" placeholder="เช่น นายสมชาย" required></div><div><label for="clubName" class="block text-sm font-medium text-gray-700">ชื่อชมรม</label><select id="clubName" name="clubName" class="input-field" required><option value="">-- เลือกชมรม --</option><option value="Programming">Programming Club</option><option value="Design">Design Studio</option><option value="Media">Media Production</option></select></div><div class="flex space-x-4 pt-2"><button type="button" onclick="saveDataToLocalStorage()" class="btn-primary flex-1">บันทึกข้อมูลใน Local Storage</button><button type="button" id="submitAllBtn" onclick="sendAllDataToSheet()" class="btn-secondary flex-1"><i class="fas fa-save"></i> ส่งข้อมูลทั้งหมดไป Google Sheet</button></div></form><div id="localStorageStatus" class="mt-4 text-center text-sm font-medium text-gray-600"></div></section><!-- ส่วนแสดงข้อมูล Google Sheet --><section class="bg-white/90 p-6 rounded-xl shadow-inner"><h2 class="text-2xl font-semibold mb-4 text-gray-700">ข้อมูลสมาชิกจาก Google Sheet</h2><button type="button" id="updateDataBtn" onclick="loadDataFromSheet()" class="btn-primary mb-4"><i class="fas fa-sync-alt"></i> อัพเดทข้อมูลจาก Google Sheet</button><div class="overflow-x-auto rounded-lg shadow-md">
 <table id="sheetDataDisplay" class="min-w-full data-table">
  <thead>
   <tr>
    <th>ID</th>
    <th>ชื่อสมาชิก</th>
    <th>ชมรม</th>
    <th>วัน-เวลาที่บันทึก</th>
   </tr>
  </thead>
  <tbody>
   <tr><td colspan="4" class="text-center text-gray-500 py-4">กด "อัพเดทข้อมูลจาก Google Sheet" เพื่อเรียกดู</td></tr>
  </tbody>
 </table>
</div>
</section></div><script>// URL สำหรับ Google App Script (GS) ที่จะจัดการการส่งและรับข้อมูลconst GS_EXEC_URL = 'https://script.google.com/macros/s/AKfycbx2Mk1JgpdW_ob-zp2QgUq3dbijn8NAIYKmeRAENmv7jShDAM8wvInKHB-X9uEWRguWTA/exec';//---------------------------------------------------------
// 1. ฟังก์ชัน Local Storage (บันทึกข้อมูลถาวรในเบราว์เซอร์)
//---------------------------------------------------------

function getLocalData() {
    const data = localStorage.getItem(&#39;clubData&#39;);
    return data ? JSON.parse(data) : [];
}

function saveDataToLocalStorage() {
    const form = document.getElementById(&#39;clubForm&#39;);
    const memberId = form.memberId.value.trim();
    const memberName = form.memberName.value.trim();
    const clubName = form.clubName.value.trim();

    if (!memberId || !memberName || !clubName) {
        Swal.fire(&#39;ข้อผิดพลาด&#39;, &#39;กรุณากรอกข้อมูลให้ครบถ้วนก่อนบันทึกใน Local Storage&#39;, &#39;error&#39;);
        return;
    }

    let currentData = getLocalData();
    const timestamp = new Date().toLocaleString(&#39;th-TH&#39;, { hour12: false });

    // ตรวจสอบและอัพเดทข้อมูลที่มีอยู่ หรือเพิ่มข้อมูลใหม่
    const existingIndex = currentData.findIndex(item =&gt; item.memberId === memberId);

    const newData = {
        memberId: memberId,
        memberName: memberName,
        clubName: clubName,
        timestamp: timestamp
    };

    if (existingIndex &gt; -1) {
        currentData[existingIndex] = newData; // อัพเดท
        Swal.fire(&#39;สำเร็จ&#39;, `อัพเดทข้อมูลสมาชิก ID: ${memberId} ใน Local Storage แล้ว`, &#39;success&#39;);
    } else {
        currentData.push(newData); // เพิ่มใหม่
        Swal.fire(&#39;สำเร็จ&#39;, `บันทึกข้อมูลสมาชิก ID: ${memberId} ลงใน Local Storage แล้ว`, &#39;success&#39;);
    }

    localStorage.setItem(&#39;clubData&#39;, JSON.stringify(currentData));
    document.getElementById(&#39;localStorageStatus&#39;).textContent = `มีข้อมูลใน Local Storage ${currentData.length} รายการ`;
    form.reset();
}

// โหลดข้อมูลเมื่อเริ่มต้น (ใน initializeApp)
function initializeApp() {
    // อัพเดทสถานะ Local Storage
    const currentData = getLocalData();
    document.getElementById(&#39;localStorageStatus&#39;).textContent = `มีข้อมูลใน Local Storage ${currentData.length} รายการ`;
}


//---------------------------------------------------------
// 2. ฟังก์ชัน Google Sheet - บันทึกข้อมูล (JSONP)
//---------------------------------------------------------

function sendAllDataToSheet() {
    const allLocalData = getLocalData();

    if (allLocalData.length === 0) {
        Swal.fire(&#39;ไม่มีข้อมูล&#39;, &#39;ไม่มีข้อมูลใน Local Storage ที่ต้องส่ง&#39;, &#39;warning&#39;);
        return;
    }

    // แสดงสถานะกำลังบันทึก
    Swal.fire({
        title: &#39;กำลังบันทึกข้อมูล...&#39;,
        text: &#39;กรุณารอสักครู่ ระบบกำลังส่งข้อมูลไปยัง Google Sheet&#39;,
        icon: &#39;info&#39;,
        showConfirmButton: false,
        allowOutsideClick: false,
        willOpen: () =&gt; {
            Swal.showLoading();
        }
    });

    // เตรียมข้อมูลและ JSONP
    const callbackName = &#39;sheetSubmissionCallback&#39;;
    const dataToSend = {
        action: &#39;save&#39;,
        data: JSON.stringify(allLocalData)
    };

    makeJsonpRequest(GS_EXEC_URL, dataToSend, callbackName);
}

// ฟังก์ชัน Callback สำหรับการบันทึกข้อมูล
window.sheetSubmissionCallback = function(response) {
    if (response.result === &#39;success&#39;) {
        // ล้าง Local Storage หลังจากบันทึกสำเร็จ (ทางเลือก)
        // localStorage.removeItem(&#39;clubData&#39;); 
        // document.getElementById(&#39;localStorageStatus&#39;).textContent = &#39;Local Storage ถูกเคลียร์แล้ว&#39;;
        Swal.fire(
            &#39;บันทึกสำเร็จ!&#39;,
            `บันทึกข้อมูลสมาชิก ${response.count} รายการไปยัง Google Sheet เรียบร้อยแล้ว`,
            &#39;success&#39;
        );
    } else {
        console.error(&#39;GS Error:&#39;, response.error);
        Swal.fire(
            &#39;บันทึกไม่สำเร็จ&#39;,
            `เกิดข้อผิดพลาดในการบันทึก: ${response.error || &#39;โปรดตรวจสอบ Google App Script&#39;}`,
            &#39;error&#39;
        );
    }
    // อัพเดทสถานะ Local Storage อีกครั้ง
    initializeApp();
}


//---------------------------------------------------------
// 3. ฟังก์ชัน Google Sheet - เรียกดูข้อมูล (JSONP)
//---------------------------------------------------------

function loadDataFromSheet() {
    // แสดงสถานะกำลังโหลด
    Swal.fire({
        title: &#39;กำลังอัพเดทข้อมูล...&#39;,
        text: &#39;กำลังดึงข้อมูลล่าสุดจาก Google Sheet&#39;,
        icon: &#39;info&#39;,
        showConfirmButton: false,
        allowOutsideClick: false,
        willOpen: () =&gt; {
            Swal.showLoading();
        }
    });

    const callbackName = &#39;sheetRetrievalCallback&#39;;
    const dataToRequest = {
        action: &#39;read&#39;
    };

    makeJsonpRequest(GS_EXEC_URL, dataToRequest, callbackName);
}

// ฟังก์ชัน Callback สำหรับการเรียกดูข้อมูล
window.sheetRetrievalCallback = function(response) {
    if (response.result === &#39;success&#39; &amp;&amp; response.data) {
        displaySheetData(response.data);
        Swal.fire(
            &#39;อัพเดทสำเร็จ!&#39;,
            `ดึงข้อมูลสมาชิก ${response.data.length} รายการจาก Google Sheet เรียบร้อยแล้ว`,
            &#39;success&#39;
        );
    } else {
        console.error(&#39;GS Error:&#39;, response.error);
        Swal.fire(
            &#39;อัพเดทไม่สำเร็จ&#39;,
            `เกิดข้อผิดพลาดในการดึงข้อมูล: ${response.error || &#39;โปรดตรวจสอบ Google App Script และ Sheet&#39;}`,
            &#39;error&#39;
        );
    }
}

// ฟังก์ชันแสดงผลในตาราง
function displaySheetData(data) {
    const tableBody = document.querySelector(&#39;#sheetDataDisplay tbody&#39;);
    tableBody.innerHTML = &#39;&#39;; // เคลียร์ข้อมูลเก่า

    if (data.length === 0) {
        tableBody.innerHTML = &#39;&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;text-center text-gray-500 py-4&quot;&gt;ไม่พบข้อมูลใน Google Sheet&lt;/td&gt;&lt;/tr&gt;&#39;;
        return;
    }

    data.forEach(row =&gt; {
        const tr = document.createElement(&#39;tr&#39;);
        // คาดหวังลำดับคอลัมน์จาก GAS: [memberId, memberName, clubName, timestamp]
        tr.innerHTML = `
            &lt;td class=&quot;font-mono&quot;&gt;${row[0] || &#39;-&#39;}&lt;/td&gt;
            &lt;td&gt;${row[1] || &#39;-&#39;}&lt;/td&gt;
            &lt;td&gt;${row[2] || &#39;-&#39;}&lt;/td&gt;
            &lt;td class=&quot;text-xs text-gray-500&quot;&gt;${row[3] || &#39;-&#39;}&lt;/td&gt;
        `;
        tableBody.appendChild(tr);
    });
}

//---------------------------------------------------------
// 4. JSONP Helper Function (ใช้งานร่วมกันทั้งบันทึกและเรียกดู)
//---------------------------------------------------------

/**
 * สร้างคำขอ JSONP
 * @param {string} url - URL ของ Google App Script
 * @param {object} data - ข้อมูลที่จะส่ง
 * @param {string} callbackName - ชื่อฟังก์ชัน callback ที่จะถูกเรียกเมื่อได้รับข้อมูล
 */
function makeJsonpRequest(url, data, callbackName) {
    const scriptId = &#39;jsonp-script-&#39; + Date.now();
    
    // Construct the URL with data and callback
    const urlParams = new URLSearchParams(data).toString();
    const finalUrl = `${url}?${urlParams}&amp;callback=${callbackName}`;

    // 1. Inject the script tag
    const script = document.createElement(&#39;script&#39;);
    script.src = finalUrl;
    script.id = scriptId;
    
    // 2. Add error handling for script load (e.g., 404 or script issue)
    const timeout = setTimeout(() =&gt; {
        if(document.getElementById(scriptId)) {
            document.body.removeChild(script);
            Swal.fire(&#39;Time Out&#39;, &#39;ไม่สามารถติดต่อ Google App Script ได้ภายในเวลาที่กำหนด&#39;, &#39;error&#39;);
        }
    }, 15000); // 15 วินาที

    script.onerror = () =&gt; {
        clearTimeout(timeout);
        if(document.getElementById(scriptId)) {
            document.body.removeChild(script);
            Swal.fire(&#39;Connection Error&#39;, &#39;ไม่สามารถโหลด Google App Script ได้ โปรดตรวจสอบ URL&#39;, &#39;error&#39;);
        }
        delete window[callbackName];
    };
    
    // Clean up the script and timeout after success (handled in callback)
    const originalCallback = window[callbackName];
    window[callbackName] = function(response) {
        clearTimeout(timeout);
        originalCallback(response);
        
        // Clean up the script tag and the dynamic function
        const scriptTag = document.getElementById(scriptId);
        if (scriptTag) {
            document.body.removeChild(scriptTag);
        }
        delete window[callbackName];
    };


    document.body.appendChild(script);
}


// เริ่มต้นการทำงานเมื่อ DOM โหลดเสร็จสิ้น
document.addEventListener(&#39;DOMContentLoaded&#39;, initializeApp);
</script></body></html>